---
- name: Include variables from meta/main.yml
  include_vars:
    file: "{{ generator_role_path }}/meta/main.yml"
    name: meta

- name: Copy License File
  copy:
    src: LICENSE.txt
    dest: "{{ generator_role_path }}/LICENSE.txt"

- name: Generate molecule files | Create Necessary Dirs
  file:
    path: "{{ generator_role_path }}/molecule/{{ item.name }}"
    state: directory
  loop: "{{ generator_molecule_scenarios + [ {'name': 'default'} ] }}"

- name: Copy default files if not present
  when:
    - generator_default_files is defined
    - generator_default_files is iterable
  block:
    - name: Copy default files if not present | Check presence
      loop: "{{ generator_default_files }}"
      register: generator_default_files_presence
      stat:
        path: "{{ generator_role_path }}/{{ item.dest | default(item) }}"

    - name: Copy default files if not present | Copy file if needed
      loop: "{{ generator_default_files_presence['results'] }}"
      loop_control:
        index_var: index
        label: "{{ generator_default_files[index]['dest'] | default(generator_default_files[index]) }}"
      when: not item.stat.exists | bool
      template:
        src: "{{ generator_default_files[index]['src'] | default('defaults/' ~ generator_default_files[index] ~ '.j2') }}"
        dest: "{{ generator_role_path }}/{{ generator_default_files[index]['dest'] | default(generator_default_files[index]) }}"

- name: Generate molecule files | Create molecule.yml files
  template:
    src: "molecule/{{ molecule_file.format }}/molecule.yml.j2"
    dest: "{{ generator_role_path }}/molecule/{{ molecule_file.name }}/molecule.yml"
  loop_control:
    loop_var: molecule_file
  loop: "{{ generator_molecule_scenarios }}"

- name: Generate molecule files | Check if default molecule.yml is present
  stat:
    path: "{{ generator_role_path }}/molecule/default/molecule.yml"
  register: default_molecule_yml_stat

- name: Generate molecule files | Link default molecule.yml if not present
  file:
    state: link
    src: "{{ generator_role_path }}/molecule/{{ generator_molecule_default_scenario }}/molecule.yml"
    dest: "{{ generator_role_path }}/molecule/default/molecule.yml"

- name: Generate molecule files | Check if prepare.yml is present
  stat:
    path: "{{ generator_role_path }}/molecule/default/prepare.yml"
  register: prepare_stat

- name: Generate molecule files | Link prepare.yml if present
  when: prepare_stat.stat.exists | bool
  loop: "{{ generator_molecule_scenarios }}"
  file:
    state: link
    src: "{{ generator_role_path }}/molecule/default/prepare.yml"
    dest: "{{ generator_role_path }}/molecule/{{ item.name }}/prepare.yml"

- name: Generate molecule files | Check if converge.yml is present
  stat:
    path: "{{ generator_role_path }}/molecule/default/converge.yml"
  register: converge_stat

- name: Generate molecule files | Link converge.yml if present
  when: converge_stat.stat.exists | bool
  loop: "{{ generator_molecule_scenarios }}"
  file:
    state: link
    src: "{{ generator_role_path }}/molecule/default/converge.yml"
    dest: "{{ generator_role_path }}/molecule/{{ item.name }}/converge.yml"

- name: Generate molecule files | Check if verify.yml is present
  stat:
    path: "{{ generator_role_path }}/molecule/default/verify.yml"
  register: verify_stat

- name: Generate molecule files | Link verify.yml if present
  when: verify_stat.stat.exists | bool
  loop: "{{ generator_molecule_scenarios }}"
  file:
    state: link
    src: "{{ generator_role_path }}/molecule/default/verify.yml"
    dest: "{{ generator_role_path }}/molecule/{{ item.name }}/verify.yml"
